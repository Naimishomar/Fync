import React, { useEffect, useState } from 'react';
import { View, Text, FlatList, Image, TouchableOpacity, ActivityIndicator } from 'react-native';
import { useNavigation, useRoute, RouteProp } from '@react-navigation/native';
import { RootStackParamList } from '../../App';
import axios from '../../context/axiosConfig';
import Ionicons from "@expo/vector-icons/Ionicons";
import * as Print from 'expo-print';
import { shareAsync } from 'expo-sharing';
import socket from '../../utils/socket'; 

type ScreenRouteProp = RouteProp<RootStackParamList, 'LeaderboardScreen'>;

const LeaderboardScreen = () => {
  const route = useRoute<ScreenRouteProp>();
  const navigation = useNavigation<any>();
  const { roomId, myScore } = route.params;

  const [leaders, setLeaders] = useState<any[]>([]);
  const [loading, setLoading] = useState(true);
  const [downloading, setDownloading] = useState(false);

  // 2. SETUP REAL-TIME LISTENERS
  useEffect(() => {
    // Initial Fetch
    fetchLeaderboard();

    // Join the socket room as a "watcher"
    socket.emit("watch_leaderboard", { roomId });

    // Listen for updates from backend
    const onUpdate = () => {
        console.log("üîî New submission received! Refreshing...");
        fetchLeaderboard(); // Auto-refresh data
    };

    socket.on("leaderboard_updated", onUpdate);

    // Cleanup listeners when leaving screen
    return () => {
        socket.off("leaderboard_updated", onUpdate);
        // Optional: Leave room logic if needed, but socket disconnect handles it usually
    };
  }, [roomId]);

  const fetchLeaderboard = async () => {
    try {
      // Don't set loading=true here to avoid screen flickering on updates
      const res = await axios.get(`/quiz/leaderboard/${roomId}`);
      setLeaders(res.data);
    } catch (err) {
      console.log("Error fetching leaderboard", err);
    } finally {
      setLoading(false);
    }
  };

  const downloadPDF = async () => {
    if (leaders.length === 0) {
      return Alert.alert("Empty", "No data to download.");
    }
    setDownloading(true);
    try {
      // 1. Generate Table Rows HTML
      const tableRows = leaders.map((item, index) => `
        <tr>
          <td style="text-align: center;">${index + 1}</td>
          <td>
             <div style="font-weight: bold;">${item.user?.name || "Unknown"}</div>
             <div style="font-size: 10px; color: #666;">@${item.user?.username || "unknown"}</div>
          </td>
          <td style="text-align: center; font-weight: bold; font-size: 16px;">${item.score}</td>
        </tr>
      `).join('');

      const html = `
        <html>
          <head>
            <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no" />
            <style>
              body { font-family: 'Helvetica', sans-serif; padding: 40px; }
              h1 { text-align: center; color: #4F46E5; margin-bottom: 5px; }
              h3 { text-align: center; color: #6b7280; font-weight: normal; margin-top: 0; }
              table { width: 100%; border-collapse: collapse; margin-top: 30px; border-radius: 8px; overflow: hidden; }
              th, td { border: 1px solid #e5e7eb; padding: 12px 15px; text-align: left; }
              th { background-color: #f3f4f6; color: #374151; font-weight: bold; text-transform: uppercase; font-size: 12px; }
              tr:nth-child(even) { background-color: #f9fafb; }
              .footer { text-align: center; margin-top: 40px; font-size: 12px; color: #9ca3af; }
            </style>
          </head>
          <body>
            <h1>üèÜ Leaderboard Results</h1>
            <h3>Room ID: ${roomId}</h3>
            
            <table>
              <thead>
                <tr>
                  <th style="width: 10%; text-align: center;">Rank</th>
                  <th>Participant</th>
                  <th style="width: 15%; text-align: center;">Score</th>
                </tr>
              </thead>
              <tbody>
                ${tableRows}
              </tbody>
            </table>

            <div class="footer">
              Generated by Fync App ‚Ä¢ ${new Date().toLocaleDateString()}
            </div>
          </body>
        </html>
      `;

      // 3. Generate PDF File
      const { uri } = await Print.printToFileAsync({ html });
      
      // 4. Share/Save File
      await shareAsync(uri, { UTI: '.pdf', mimeType: 'application/pdf' });

    } catch (error) {
      console.error("PDF Generation Error:", error);
      Alert.alert("Error", "Could not generate PDF. Please try again.");
    } finally {
      setDownloading(false);
    }
  };

  const renderItem = ({ item, index }: { item: any; index: number }) => (
    <View className="flex-row items-center bg-white p-4 mb-2 rounded-xl shadow-sm border border-gray-100">
      <Text className={`text-lg font-bold w-8 ${index < 3 ? 'text-yellow-600' : 'text-gray-500'}`}>
        #{index + 1}
      </Text>
      
      <View className="w-10 h-10 bg-gray-200 rounded-full mr-3 justify-center items-center overflow-hidden">
        {item.user?.avatar ? (
          <Image source={{ uri: item.user.avatar }} className="w-full h-full" />
        ) : (
          <Text className="font-bold text-gray-500">{item.user?.username?.[0]?.toUpperCase()}</Text>
        )}
      </View>

      <Text className="flex-1 font-semibold text-gray-800 text-lg">
        {item.user?.name || item.user?.username || "Unknown"}
      </Text>

      <View className="bg-blue-100 px-3 py-1 rounded-full">
        <Text className="font-bold text-blue-700">{item.score} pts</Text>
      </View>
    </View>
  );

  return (
    <View className="flex-1 bg-gray-50 pt-10 px-4">
      {/* HEADER */}
      <View className="flex-row items-center justify-between mb-6">
        <TouchableOpacity onPress={() => navigation.navigate("Tabs")}>
          <Ionicons name="home" size={24} color="black" />
        </TouchableOpacity>
        
        <Text className="text-2xl font-bold text-center">üèÜ Leaderboard</Text>
        
        {/* ACTION BUTTONS */}
        <View className="flex-row gap-4">
            {/* Manual Refresh (Optional now, but good to keep) */}
            <TouchableOpacity onPress={fetchLeaderboard}>
                <Ionicons name="refresh" size={24} color="#4F46E5" />
            </TouchableOpacity>

            <TouchableOpacity onPress={downloadPDF} disabled={downloading}>
                {downloading ? (
                    <ActivityIndicator size="small" color="#4F46E5" />
                ) : (
                    <Ionicons name="cloud-download-outline" size={28} color="#4F46E5" />
                )}
            </TouchableOpacity>
        </View>
      </View>

      <Text className="text-xl font-bold text-center mb-4 text-gray-600">Room: {roomId}</Text>

      {/* Show user's own score only if they played */}
      {myScore !== undefined && (
        <View className="bg-purple-600 p-6 rounded-2xl mb-6 shadow-lg">
          <Text className="text-white text-center font-bold text-lg mb-1">Your Score</Text>
          <Text className="text-white text-center text-4xl font-extrabold">{myScore}</Text>
        </View>
      )}

      {loading ? (
        <ActivityIndicator size="large" color="#4F46E5" className="mt-10" />
      ) : (
        <FlatList
          data={leaders}
          keyExtractor={(item) => item._id}
          renderItem={renderItem}
          showsVerticalScrollIndicator={false}
          ListEmptyComponent={
            <Text className="text-center text-gray-500 mt-10">Waiting for submissions...</Text>
          }
        />
      )}
    </View>
  );
};

export default LeaderboardScreen;